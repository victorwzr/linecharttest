<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monetary Policy Rules – Interactive Line Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      --color-main: #7e0a0d;
      --color-second: #ebc6c0;
      --color-third: #bebebe;
      --color-muted: #787878;
      --color-deep: #161c4e;
      --color-chart1: #376092;
      --color-chart2: #82AEB1;
      --color-chart3: #015555;
      --color-chart4: #4099ED;
      color-scheme: light;
    }

    body {
      margin: 0;
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--color-second) 0%, #ffffff 55%);
      color: #1f1f1f;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 1.75rem 1.5rem 2rem;
      box-shadow: 0 12px 30px rgba(126, 10, 13, 0.12);
      border: 1px solid var(--color-third);
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      text-align: center;
      color: var(--color-main);
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    .control-group {
      border-radius: 10px;
      padding: 0.75rem 0.9rem;
      background: #fff7f6;
      border: 1px solid var(--color-second);
    }

    .control-group h2 {
      font-size: 0.95rem;
      margin: 0 0 0.4rem;
      font-weight: 600;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.35rem;
      color: var(--color-deep);
    }

    select {
      width: 100%;
      padding: 0.35rem 0.5rem;
      border-radius: 6px;
      border: 1px solid var(--color-third);
      font-size: 0.9rem;
      background: #ffffff;
      color: #1f1f1f;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .checkbox-label input[type="checkbox"] {
      cursor: pointer;
      width: 16px;
      height: 16px;
    }

    .chart-wrapper {
      position: relative;
      height: 504px;
    }

    .note {
      font-size: 0.78rem;
      color: var(--color-muted);
      margin-top: 0.6rem;
      text-align: right;
    }

    .error {
      color: var(--color-main);
      font-size: 0.85rem;
      margin-top: 0.75rem;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>Monetary Policy Rules vs Bank Rate</h1>
    <section class="controls">
      <div class="control-group">
        <h2>Rules</h2>
        <div id="series2Rule" class="checkbox-group"></div>

        <h2 for="series2Year">Year</h2>
        <select id="series2Year"></select>
      </div>
    </section>

    <div class="chart-wrapper">
      <canvas id="rateChart"></canvas>
    </div>

    <p id="errorMessage" class="error" style="display:none"></p>
  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /*****************************************************
     * 1. CONFIG – PUT YOUR GOOGLE SHEET CSV URL HERE
     *****************************************************/
    // After you publish your Google Sheet as CSV (see instructions below),
    // paste the CSV URL into the string below:
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-5NpX5GcXpP-7yzPEhUznZXLxsA6gU8llOaVQgyJ34GxrpAJCZA_gb8ZxIRIwKeBIohusq8onHn-I/pub?output=csv";

    /*****************************************************
     * 2. DATA STRUCTURES
     *****************************************************/
    const monthLabels = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    // The rule/column names we expect in the sheet:
    const RULE_COLUMNS = [
      "Bank Rate",
      "Taylor Rule",
      "Balance Rule",
      "First Difference Rule",
      "Inertial Rule"
    ];

    const COMPARISON_RULES = RULE_COLUMNS.filter(r => r !== "Bank Rate");

    // Will become: { [year]: { [ruleName]: [12 monthly values] } }
    const dataByYear = {};

    let availableYears = [];   // e.g. [2023, 2024, 2025]
    let chartInstance = null;
    let globalMin = null;
    let globalMax = null;

    const series2RuleSelect = document.getElementById("series2Rule");
    const series2YearSelect = document.getElementById("series2Year");
    const errorMessageEl = document.getElementById("errorMessage");

    /*****************************************************
     * 3. UTILITIES
     *****************************************************/
    function parseDateFlexible(dateStr) {
      if (!dateStr) return null;

      // already a Date object
      if (Object.prototype.toString.call(dateStr) === "[object Date]") {
        return isNaN(dateStr.getTime()) ? null : dateStr;
      }

      // try to handle "dd-mm-yyyy", "dd/mm/yyyy", or "yyyy-mm-dd"
      const parts = String(dateStr).trim().split(/[-/]/);
      if (parts.length === 3) {
        let day, month, year;
        if (parts[0].length === 4) {
          // yyyy-mm-dd
          year = +parts[0];
          month = +parts[1];
          day = +parts[2];
        } else {
          // assume dd-mm-yyyy
          day = +parts[0];
          month = +parts[1];
          year = +parts[2];
        }
        const d = new Date(year, month - 1, day);
        return isNaN(d.getTime()) ? null : d;
      }

      // last fallback
      const d = new Date(dateStr);
      return isNaN(d.getTime()) ? null : d;
    }

    function toNumber(value) {
      if (value == null || value === "") return null;
      const num = parseFloat(String(value).replace("%", "").trim());
      return isNaN(num) ? null : num;
    }

    function fillSelect(select, options, { defaultValue } = {}) {
      select.innerHTML = "";
      options.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.label;
        if (defaultValue !== undefined && defaultValue === opt.value) {
          o.selected = true;
        }
        select.appendChild(o);
      });
    }

    /*****************************************************
     * 4. LOAD & PROCESS GOOGLE SHEET DATA
     *****************************************************/
    function showError(message) {
      errorMessageEl.style.display = "block";
      errorMessageEl.textContent = message;
    }

    function loadSheetData() {
      if (!SHEET_CSV_URL || SHEET_CSV_URL.startsWith("PASTE_")) {
        showError(
          "Please edit this file and set SHEET_CSV_URL to your published Google Sheet CSV link."
        );
        return;
      }

      Papa.parse(SHEET_CSV_URL, {
        download: true,
        header: true,
        dynamicTyping: false,
        complete: function (results) {
          if (results.errors && results.errors.length) {
            console.error(results.errors);
            showError(
              "Error parsing CSV from Google Sheets. Check the browser console for details."
            );
            return;
          }

          const rows = results.data.filter(row => row.Date);
          if (!rows.length) {
            showError("No data rows found in the CSV. Check that the sheet has a Date column.");
            return;
          }

          processRows(rows);

          if (!availableYears.length) {
            showError("No usable data found after parsing. Verify column names and dates.");
            return;
          }

          initUI();
          initChart();
          updateChart();
        },
        error: function (err) {
          console.error(err);
          showError(
            "Error downloading CSV from Google Sheets. Check that the link is correct and published."
          );
        }
      });
    }

    function processRows(rows) {
      rows.forEach(row => {
        const date = parseDateFlexible(row.Date);
        if (!date) return;

        const year = date.getFullYear();
        const monthIndex = date.getMonth(); // 0-11

        if (!dataByYear[year]) {
          dataByYear[year] = {};
          RULE_COLUMNS.forEach(rule => {
            dataByYear[year][rule] = new Array(12).fill(null);
          });
        }

        RULE_COLUMNS.forEach(rule => {
          const num = toNumber(row[rule]);
          if (num != null) {
            dataByYear[year][rule][monthIndex] = num;
            // Track global min/max
            if (globalMin === null || num < globalMin) globalMin = num;
            if (globalMax === null || num > globalMax) globalMax = num;
          }
        });
      });

      availableYears = Object.keys(dataByYear)
        .map(y => +y)
        .sort((a, b) => a - b);
    }

    /*****************************************************
     * 5. UI & CHART SETUP
     *****************************************************/
    function initUI() {
      // populate comparison rules as checkboxes
      COMPARISON_RULES.forEach((rule, index) => {
        const label = document.createElement("label");
        label.className = "checkbox-label";
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = rule;
        checkbox.id = `rule-${index}`;
        checkbox.checked = rule === "Taylor Rule"; // default checked
        checkbox.addEventListener("change", updateChart);
        
        const span = document.createElement("span");
        span.textContent = rule;
        
        label.appendChild(checkbox);
        label.appendChild(span);
        series2RuleSelect.appendChild(label);
      });

      // populate year select
      const yearOptions = availableYears.map(y => ({
        value: String(y),
        label: String(y)
      }));

      const defaultYear = availableYears.includes(2024) ? "2024" : String(availableYears[availableYears.length - 1]);

      fillSelect(series2YearSelect, yearOptions, { defaultValue: defaultYear });

      series2YearSelect.addEventListener("change", updateChart);
    }

    function getSeriesData(year, rule) {
      if (!year || !rule) return new Array(12).fill(null);
      const yearData = dataByYear[year];
      if (!yearData || !yearData[rule]) return new Array(12).fill(null);
      return yearData[rule];
    }

    function initChart() {
      const ctx = document.getElementById("rateChart").getContext("2d");

      const palette = [
        "#7e0a0d", // main (Bank Rate highlight)
        "#376092",
        "#82AEB1",
        "#015555",
        "#4099ED"
      ];

      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: monthLabels,
          datasets: [
            {
              label: "Bank Rate",
              data: [],
              borderColor: palette[0],
              backgroundColor: palette[0],
              borderWidth: 3,
              pointRadius: 4,
              pointBackgroundColor: "#ffffff",
              pointBorderColor: palette[0],
              tension: 0.2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "nearest",
            axis: "x",
            intersect: false
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "Month"
              }
            },
            y: {
              title: {
                display: true,
                text: "Interest rate (%)"
              },
              beginAtZero: false,
              ticks: {
                callback: function (value) {
                  return parseFloat(value).toFixed(2) + "%";
                }
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: "top"
            },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  const v = ctx.parsed.y;
                  if (v == null) {
                    return ctx.dataset.label + ": no data";
                  }
                  return ctx.dataset.label + ": " + v.toFixed(2) + "%";
                }
              }
            }
          }
        }
      });
    }

    function updateChart() {
      if (!chartInstance) return;

      const selectedYear = series2YearSelect.value;

      // Bank Rate dataset (uses same year as rules)
      const bankRateData = getSeriesData(selectedYear, "Bank Rate");
      chartInstance.data.datasets[0].label = `Bank Rate (${selectedYear})`;
      chartInstance.data.datasets[0].data = bankRateData;

      // Build comparison datasets from checked checkboxes
      const selectedRules = Array.from(series2RuleSelect.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      const palette = ["#7e0a0d", "#376092", "#82AEB1", "#015555", "#4099ED"];

      const comparisonDatasets = selectedRules.map((rule, idx) => {
        const color = palette[(idx + 1) % palette.length]; // skip 0 because used for bank rate
        return {
          label: `${rule} (${selectedYear})`,
          data: getSeriesData(selectedYear, rule),
          borderColor: color,
          backgroundColor: color,
          borderWidth: 2,
          borderDash: rule === "Bank Rate" ? [] : [6, 4],
          pointRadius: 3,
          pointBackgroundColor: "#ffffff",
          pointBorderColor: color,
          tension: 0.2
        };
      });

      chartInstance.data.datasets = [chartInstance.data.datasets[0], ...comparisonDatasets];

      chartInstance.update();
    }

    // Kick everything off
    loadSheetData();
  </script>
</body>
</html>

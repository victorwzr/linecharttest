<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monetary Policy Rules – Interactive Line Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      --color-main: #7e0a0d;
      --color-second: #ebc6c0;
      --color-third: #bebebe;
      --color-muted: #787878;
      --color-deep: #161c4e;
      --color-chart1: #376092;
      --color-chart2: #82AEB1;
      --color-chart3: #015555;
      --color-chart4: #4099ED;
      color-scheme: light;
    }

    body {
      margin: 0;
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--color-second) 0%, #ffffff 55%);
      color: #1f1f1f;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 1.75rem 1.5rem 2rem;
      box-shadow: 0 12px 30px rgba(126, 10, 13, 0.12);
      border: 1px solid var(--color-third);
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      text-align: center;
      color: var(--color-main);
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    .control-group {
      border-radius: 10px;
      padding: 0.75rem 0.9rem;
      background: #fff7f6;
      border: 1px solid var(--color-second);
    }

    .control-group h2 {
      font-size: 0.95rem;
      margin: 0 0 0.4rem;
      font-weight: 600;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.35rem;
      color: var(--color-deep);
    }

    select {
      width: 100%;
      padding: 0.35rem 0.5rem;
      border-radius: 6px;
      border: 1px solid var(--color-third);
      font-size: 0.9rem;
      background: #ffffff;
      color: #1f1f1f;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .checkbox-label input[type="checkbox"] {
      cursor: pointer;
      width: 16px;
      height: 16px;
    }

    .slider-container {
      margin-top: 1rem;
      padding: 0.75rem;
      background: #fff7f6;
      border: 1px solid var(--color-second);
      border-radius: 10px;
    }

    .slider-container label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--color-deep);
    }

    .slider-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .slider-wrapper input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: var(--color-third);
      outline: none;
      -webkit-appearance: none;
    }

    .slider-wrapper input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--color-main);
      cursor: pointer;
    }

    .slider-wrapper input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--color-main);
      cursor: pointer;
      border: none;
    }

    .date-range-display {
      font-size: 0.85rem;
      color: var(--color-deep);
      min-width: 180px;
      text-align: center;
      font-weight: 500;
    }

    .chart-wrapper {
      position: relative;
      height: 504px;
    }

    .note {
      font-size: 0.78rem;
      color: var(--color-muted);
      margin-top: 0.6rem;
      text-align: right;
    }

    .error {
      color: var(--color-main);
      font-size: 0.85rem;
      margin-top: 0.75rem;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>Monetary Policy Rules vs Bank Rate</h1>
    <section class="controls">
      <div class="control-group">
        <h2>Rules</h2>
        <div id="series2Rule" class="checkbox-group"></div>
      </div>
    </section>

    <div class="slider-container">
      <label>Date Range (12 months)</label>
      <div class="slider-wrapper">
        <input type="range" id="dateRangeSlider" min="0" max="0" value="0" step="1" />
        <span id="dateRangeDisplay" class="date-range-display"></span>
      </div>
    </div>

    <div class="chart-wrapper">
      <canvas id="rateChart"></canvas>
    </div>

    <p id="errorMessage" class="error" style="display:none"></p>
  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /*****************************************************
     * 1. CONFIG – PUT YOUR GOOGLE SHEET CSV URL HERE
     *****************************************************/
    // After you publish your Google Sheet as CSV (see instructions below),
    // paste the CSV URL into the string below:
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-5NpX5GcXpP-7yzPEhUznZXLxsA6gU8llOaVQgyJ34GxrpAJCZA_gb8ZxIRIwKeBIohusq8onHn-I/pub?output=csv";

    /*****************************************************
     * 2. DATA STRUCTURES
     *****************************************************/
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    // The rule/column names we expect in the sheet:
    const RULE_COLUMNS = [
      "Bank Rate",
      "Taylor Rule",
      "Balance Rule",
      "First Difference Rule",
      "Inertial Rule"
    ];

    const COMPARISON_RULES = RULE_COLUMNS.filter(r => r !== "Bank Rate");

    // Chronological data: array of { date: Date, yearMonth: "YYYY-MM", data: {ruleName: value} }
    let timeSeriesData = [];
    let chartInstance = null;

    const series2RuleSelect = document.getElementById("series2Rule");
    const dateRangeSlider = document.getElementById("dateRangeSlider");
    const dateRangeDisplay = document.getElementById("dateRangeDisplay");
    const errorMessageEl = document.getElementById("errorMessage");

    /*****************************************************
     * 3. UTILITIES
     *****************************************************/
    function parseDateFlexible(dateStr) {
      if (!dateStr) return null;

      // already a Date object
      if (Object.prototype.toString.call(dateStr) === "[object Date]") {
        return isNaN(dateStr.getTime()) ? null : dateStr;
      }

      // try to handle "dd-mm-yyyy", "dd/mm/yyyy", or "yyyy-mm-dd"
      const parts = String(dateStr).trim().split(/[-/]/);
      if (parts.length === 3) {
        let day, month, year;
        if (parts[0].length === 4) {
          // yyyy-mm-dd
          year = +parts[0];
          month = +parts[1];
          day = +parts[2];
        } else {
          // assume dd-mm-yyyy
          day = +parts[0];
          month = +parts[1];
          year = +parts[2];
        }
        const d = new Date(year, month - 1, day);
        return isNaN(d.getTime()) ? null : d;
      }

      // last fallback
      const d = new Date(dateStr);
      return isNaN(d.getTime()) ? null : d;
    }

    function toNumber(value) {
      if (value == null || value === "") return null;
      const num = parseFloat(String(value).replace("%", "").trim());
      return isNaN(num) ? null : num;
    }

    /*****************************************************
     * 4. LOAD & PROCESS GOOGLE SHEET DATA
     *****************************************************/
    function showError(message) {
      errorMessageEl.style.display = "block";
      errorMessageEl.textContent = message;
    }

    function loadSheetData() {
      if (!SHEET_CSV_URL || SHEET_CSV_URL.startsWith("PASTE_")) {
        showError(
          "Please edit this file and set SHEET_CSV_URL to your published Google Sheet CSV link."
        );
        return;
      }

      Papa.parse(SHEET_CSV_URL, {
        download: true,
        header: true,
        dynamicTyping: false,
        complete: function (results) {
          if (results.errors && results.errors.length) {
            console.error(results.errors);
            showError(
              "Error parsing CSV from Google Sheets. Check the browser console for details."
            );
            return;
          }

          const rows = results.data.filter(row => row.Date);
          if (!rows.length) {
            showError("No data rows found in the CSV. Check that the sheet has a Date column.");
            return;
          }

          processRows(rows);

          if (!timeSeriesData.length) {
            showError("No usable data found after parsing. Verify column names and dates.");
            return;
          }

          initUI();
          initChart();
          updateChart();
        },
        error: function (err) {
          console.error(err);
          showError(
            "Error downloading CSV from Google Sheets. Check that the link is correct and published."
          );
        }
      });
    }

    function processRows(rows) {
      const dataMap = new Map(); // key: "YYYY-MM", value: { date, data: {} }

      rows.forEach(row => {
        const date = parseDateFlexible(row.Date);
        if (!date) return;

        const year = date.getFullYear();
        const month = date.getMonth();
        const yearMonth = `${year}-${String(month + 1).padStart(2, '0')}`;

        if (!dataMap.has(yearMonth)) {
          dataMap.set(yearMonth, {
            date: new Date(year, month, 1),
            yearMonth: yearMonth,
            data: {}
          });
        }

        const entry = dataMap.get(yearMonth);
        RULE_COLUMNS.forEach(rule => {
          const num = toNumber(row[rule]);
          if (num != null) {
            entry.data[rule] = num;
          }
        });
      });

      // Convert to sorted array
      timeSeriesData = Array.from(dataMap.values()).sort((a, b) => a.date - b.date);
    }

    /*****************************************************
     * 5. UI & CHART SETUP
     *****************************************************/
    function initUI() {
      // populate comparison rules as checkboxes
      COMPARISON_RULES.forEach((rule, index) => {
        const label = document.createElement("label");
        label.className = "checkbox-label";
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = rule;
        checkbox.id = `rule-${index}`;
        checkbox.checked = rule === "Taylor Rule"; // default checked
        checkbox.addEventListener("change", updateChart);
        
        const span = document.createElement("span");
        span.textContent = rule;
        
        label.appendChild(checkbox);
        label.appendChild(span);
        series2RuleSelect.appendChild(label);
      });

      // Setup slider
      const maxIndex = Math.max(0, timeSeriesData.length - 12);
      dateRangeSlider.max = maxIndex;
      dateRangeSlider.value = maxIndex; // Start at most recent
      
      dateRangeSlider.addEventListener("input", updateChart);
      
      updateDateRangeDisplay();
    }

    function updateDateRangeDisplay() {
      const startIndex = parseInt(dateRangeSlider.value);
      const endIndex = Math.min(startIndex + 11, timeSeriesData.length - 1);
      
      if (timeSeriesData[startIndex] && timeSeriesData[endIndex]) {
        const startDate = timeSeriesData[startIndex].date;
        const endDate = timeSeriesData[endIndex].date;
        
        const startStr = `${monthNames[startDate.getMonth()]} ${startDate.getFullYear()}`;
        const endStr = `${monthNames[endDate.getMonth()]} ${endDate.getFullYear()}`;
        
        dateRangeDisplay.textContent = `${startStr} - ${endStr}`;
      }
    }

    function initChart() {
      const ctx = document.getElementById("rateChart").getContext("2d");

      const palette = [
        "#7e0a0d", // main (Bank Rate highlight)
        "#376092",
        "#82AEB1",
        "#015555",
        "#4099ED"
      ];

      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Bank Rate",
              data: [],
              borderColor: palette[0],
              backgroundColor: palette[0],
              borderWidth: 3,
              pointRadius: 4,
              pointBackgroundColor: "#ffffff",
              pointBorderColor: palette[0],
              tension: 0.2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "nearest",
            axis: "x",
            intersect: false
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "Date"
              }
            },
            y: {
              title: {
                display: true,
                text: "Interest rate (%)"
              },
              beginAtZero: false,
              ticks: {
                callback: function (value) {
                  return parseFloat(value).toFixed(2) + "%";
                }
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: "top"
            },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  const v = ctx.parsed.y;
                  if (v == null) {
                    return ctx.dataset.label + ": no data";
                  }
                  return ctx.dataset.label + ": " + v.toFixed(2) + "%";
                }
              }
            }
          }
        }
      });
    }

    function updateChart() {
      if (!chartInstance) return;

      updateDateRangeDisplay();

      const startIndex = parseInt(dateRangeSlider.value);
      const endIndex = Math.min(startIndex + 11, timeSeriesData.length - 1);
      const windowData = timeSeriesData.slice(startIndex, endIndex + 1);

      // Generate labels
      const labels = windowData.map(d => {
        const month = monthNames[d.date.getMonth()];
        const year = d.date.getFullYear();
        return `${month} ${year}`;
      });

      chartInstance.data.labels = labels;

      // Bank Rate dataset
      const bankRateData = windowData.map(d => d.data["Bank Rate"] ?? null);
      chartInstance.data.datasets[0].data = bankRateData;

      // Build comparison datasets from checked checkboxes
      const selectedRules = Array.from(series2RuleSelect.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      const palette = ["#7e0a0d", "#376092", "#82AEB1", "#015555", "#4099ED"];

      const comparisonDatasets = selectedRules.map((rule, idx) => {
        const color = palette[(idx + 1) % palette.length];
        return {
          label: rule,
          data: windowData.map(d => d.data[rule] ?? null),
          borderColor: color,
          backgroundColor: color,
          borderWidth: 2,
          borderDash: [6, 4],
          pointRadius: 3,
          pointBackgroundColor: "#ffffff",
          pointBorderColor: color,
          tension: 0.2
        };
      });

      chartInstance.data.datasets = [chartInstance.data.datasets[0], ...comparisonDatasets];

      chartInstance.update();
    }

    // Kick everything off
    loadSheetData();
  </script>
</body>
</html>
